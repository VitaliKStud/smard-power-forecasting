

# Load Packages
```{r setup, include=FALSE}

# Load Packages
library(fhswf)
library(ggplot2)
library(tsibbledata) #0.4.1
library(dplyr)
library(tsibble)
library(fable)
library(fabletools)
library(feasts)
library(distributional)
library(lubridate)
library(broom)
library(readr)
library(tidyr)
library(datasets)
library(forecast)
library(timeDate)
library(qlcal)
library(devtools)
library(zoo)
library(corrplot)
library(scales)
library(fable.prophet)
library(mgcv)
library(MEFM)
library(TTR)
load_all()
# devtools::document()
```


# Notizen

- Erwähnen von Saisonallen Pattern für stündliche Daten meisten Täglich, Wöchentlich und jährlich

# Define data-paths and load german holidays

```{r, echo=TRUE, message=FALSE}

# Define datapaths
power_consum_path <- "dataset\\stunde_2015_2024\\Realisierter_Stromverbrauch_201501010000_202407090000_Stunde.csv"
power_generation_path <- "dataset\\stunde_2015_2024\\Realisierte_Erzeugung_201501010000_202407090000_Stunde.csv"
power_consum_smard_prediction_path <- "dataset\\propgnose_vom_smard\\Prognostizierter_Stromverbrauch_202401010000_202407090000_Stunde.csv"

```

```{r, echo=TRUE, message=FALSE}

# Load german holidays from 2015 to 2024
german_holidays <- load_german_holidays(from_year = 2015, to_year = 2024, location="/DE")
german_holidays <- german_holidays |> 
  mutate(date = as.Date(date)) |>
  select(localName, date)
```


# Load and cleanup power-consum, filling gaps and droping duplicates, keeping first value. 

```{r, echo=TRUE, message=FALSE}

load_power_consum <- function(path) {
  raw_power_consum <- read.csv2(file = path)
  
  names(raw_power_consum)[names(raw_power_consum) == "Datum.von"] <- "DateFrom"
  names(raw_power_consum)[names(raw_power_consum) == "Gesamt..Netzlast...MWh..Berechnete.Auflösungen"] <- "PowerConsum"
  
  raw_power_consum <-  raw_power_consum |>
    select(DateFrom, PowerConsum) |>
    mutate(PowerConsum = as.numeric(gsub(",", ".", gsub("\\.", "", PowerConsum))),
           DateFrom = dmy_hm(DateFrom))
  
  cleaned_power_consum <- raw_power_consum |>
    distinct(DateFrom, .keep_all = TRUE) |>
    mutate(DateIndex = DateFrom) |>
    as_tsibble(index = DateIndex) |>
    select(DateFrom, PowerConsum) |>
    fill_gaps() |>
    fill(PowerConsum, .direction = "downup") |>
    mutate(
      Weekday = wday(DateIndex, label = TRUE),  
      Date = as.Date(DateIndex),
      Year = as.factor(year(DateIndex)),
      Week = as.factor(week(DateIndex)),
      Hour = as.factor(hour(DateIndex)),
      Month = as.factor(month(DateIndex)),
    ) |>
    left_join(german_holidays, by = c("Date" = "date")) |>
    mutate(
      WorkDay = ifelse(!(Date %in% german_holidays$date | Weekday %in% c("Sa", "So")), 1, 0),
      Mo = Weekday == "Mo",
      Di = Weekday == "Di",  
      Mi = Weekday == "Mi",  
      Do = Weekday == "Do",  
      Fr = Weekday == "Fr",  
      Sa = Weekday == "Sa",  
      So = Weekday == "So",
      Holiday = ifelse(Date %in% german_holidays$date, 1, 0),
      WorkdayHolidayWeekend = paste0(ifelse(Holiday, "Feiertag", "Kein Feiertag"), ifelse(Weekday %in% c("Sa", "So"), "\nWochenende","\nKein Wochenende")),
      HolidayAndWorkDay = ifelse((Holiday & !(Weekday %in% c("Sa", "So"))), 1, 0),
      LastDayWasNotWorkDay = !lag(WorkDay, n=24),
      LastDayWasNotWorkDayAndNowWorkDay = (LastDayWasNotWorkDay & WorkDay),
      NextDayIsNotWorkDayAndNowWorkDay= (WorkDay & !lead(WorkDay, n=24)),
      LastDayWasHolodiayAndNotWeekend = ifelse((lag(Holiday, n=24) & (!Sa | !So)), 1, 0),
      NextDayIsHolidayAndNotWeekend = ifelse((lead(Holiday, n=24) & (!lead(Sa, n=24) | !lead(So, n=24))),1,0),
      HolidayName = ifelse(is.na(localName), "Regulärer Tag", localName),
      EndOfTheYear = ifelse(Week == "52"| Week == "53", 1,0),
      FirstWeekOfTheYear = ifelse(Week == "1", 1,0),
      HolidayExtended = lag(Holiday, 6, default=0) + Holiday,
      HolidayExtended = ifelse(HolidayExtended == 2, 1, HolidayExtended),
      HolidaySmoothed = HolidayExtended + sin(2 * pi * (as.numeric(Hour)+1) / 24)
    )
  
  cleaned_power_consum |>
    gg_tsdisplay(PowerConsum, plot_type = "partial", lag = 400)

  raw_power_consum <- raw_power_consum |>
    arrange(DateFrom) |>
    mutate(
      MissingValue = difftime(DateFrom, lag(DateFrom, default = first(DateFrom)), units = "hours") == 2,
      DuplicatedDate = duplicated(DateFrom),
      Year = year(DateFrom)
    )

  plot_raw_data(
    df = raw_power_consum,
    x = "DateFrom",
    y = "PowerConsum",
    color = "DuplicatedDate",
    missing_value = "MissingValue",
    file_name = "plots\\raw_power_consum.png"
  )
  
  return(list(raw_power_consum = raw_power_consum, cleaned_power_consum = cleaned_power_consum))
}

power_consum_smard_prediction_loaded <- load_power_consum(path=power_consum_smard_prediction_path)
raw_smard_pred <- power_consum_smard_prediction_loaded$raw_power_consum
cleaned_smard_pred <- power_consum_smard_prediction_loaded$cleaned_power_consum

cleaned_smard_pred <- cleaned_smard_pred |>
  mutate(.model = "SMARD")
names(cleaned_smard_pred)[names(cleaned_smard_pred) == "PowerConsum"] <- ".mean"

power_consum_loaded <- load_power_consum(path=power_consum_path)
raw_power_consum <- power_consum_loaded$raw_power_consum
cleaned_power_consum <- power_consum_loaded$cleaned_power_consum

rm(power_consum_loaded)
rm(power_consum_smard_prediction_loaded)
rm(power_consum_path)
rm(german_holidays)
rm(power_consum_smard_prediction_path)
rm(power_generation_path)

```

# Generate new Features

```{r, echo=TRUE, message=FALSE}

cleaned_power_consum$localName[is.na(cleaned_power_consum$localName)] = "Working-Day"

cleaned_power_consum$MeanLastWeek <- rollapply(cleaned_power_consum$PowerConsum, width = 24*8, FUN = function(x) mean(x[1:(24*8-25)]), align = "right", fill = NA) 

cleaned_power_consum$MeanLastTwoDays <- rollapply(cleaned_power_consum$PowerConsum, width = 24*3, FUN = function(x) mean(x[1:(24*3-25)]), align = "right", fill = NA) 

cleaned_power_consum$MaxLastOneDay <- rollapply(cleaned_power_consum$PowerConsum, width = 24*2, FUN = function(x) max(x[1:(24*2-25)]), align = "right", fill = NA) 

cleaned_power_consum$MinLastOneDay <- rollapply(cleaned_power_consum$PowerConsum, width = 24*2, FUN = function(x) min(x[1:(24*2-25)]), align = "right", fill = NA) 

cor <- cor(cleaned_power_consum[sapply(cleaned_power_consum, is.numeric)], method = c("pearson", "kendall", "spearman"), use = "complete.obs")

```

```{r, echo=TRUE, message=FALSE}

p <- ggplot(cleaned_power_consum |> mutate(WorkDay = as.factor(WorkDay)), 
            aes(x=MeanLastWeek, y=PowerConsum, color=WorkDay)) +
  geom_point(alpha=0.5, size=0.2) +
  scale_color_manual(
      name = " ",
      values =  c("1" = "#2E9FDF", "0" = "#FC4E07"),
      labels = c(
        "1" = "Werktag",
        "0" = "Wochenende oder Feiertag"
      )) +
  labs(x = "Durchschnittlicher Stromverbrauch der letzten 7 Tage [MW]", y = "Stromverbrauch [MW]") +
  theme_minimal() +
  theme(legend.position = "bottom",
          panel.background = element_rect(fill = "#EBEBEB"),
          panel.grid.major = element_line(color = "white"),
          panel.grid.minor = element_line(color = "white"),
        strip.text = element_text(size = 10)) +
  guides(color = guide_legend(override.aes = list(lwd = 3, size = 3)))
  
ggsave(
  "plots/mean_last_week.png",
  plot = p,
  width = 5.5,
  height = 3.7,
  dpi = 600
)
p
  

cor <- cor(cleaned_power_consum[sapply(cleaned_power_consum, is.numeric)], method = c("pearson", "kendall", "spearman"), use = "complete.obs")

```

```{r, echo=TRUE, message=FALSE}

p <- ggplot(cleaned_power_consum |> mutate(week_color = ifelse(Week == "1" | Week == "52" | Week == "53","Anfang und Ende des Jahres", "Reguläre Zeit")), 
            aes(x = Week, y = PowerConsum, color=week_color)) +
  geom_boxplot() +
  theme(
    legend.position = "none", 
    strip.text = element_text(size = 12) 
  ) +
  scale_color_manual(
      name = " ",
      values =  c("Reguläre Zeit" = "darkgrey", "Anfang und Ende des Jahres" = "#FC4E07")) +
  labs(
    x = "Woche",
    y = "Stromverbrauch [MW]"
  )+
  scale_x_discrete(breaks = levels(cleaned_power_consum$Week)[seq(1, length(levels(cleaned_power_consum$Week)), by = 5)]) +
  theme_minimal() +
  theme(legend.position = "bottom",
          panel.background = element_rect(fill = "#EBEBEB"),
          panel.grid.major = element_line(color = "white"),
          panel.grid.minor = element_line(color = "white"),
        strip.text = element_text(size = 10)) +
  guides(color = guide_legend(override.aes = list(lwd = 3, size = 3)))

ggsave("plots/week_boxplot.png",   plot = p,
  width = 5.5,
  height = 3.7,
  dpi = 600)

p
```



# Create different Plot for analysis

```{r echo=TRUE, message=FALSE}
load_all()
local_name_colors <- c(
  "Christi Himmelfahrt" = palette()[2],
  "Erster Weihnachtstag" = palette()[2],
  "Karfreitag" = palette()[2],
  "Neujahr" = palette()[2],
  "Ostermontag" = palette()[2],
  "Pfingstmontag" = palette()[2],
  "Reformationstag" = palette()[2],
  "Tag der Arbeit" = palette()[2],
  "Tag der Deutschen Einheit" = palette()[2],
  "Zweiter Weihnachtstag" = palette()[2],
  "Regulärer Tag" = palette()[1]
)


week_colors <- c(
  "Mo" = palette()[1],
  "Di" = palette()[1],
  "Mi" = palette()[1],
  "Do" = palette()[1],
  "Fr" = palette()[1],
  "Sa" = palette()[2],
  "So" = palette()[2]
)


working_colors <- c("1" = "#2E9FDF", "0" = "#FC4E07")

whw_colors <- c(
  "Feiertag\nKein Wochenende" = "black",
  "Kein Feiertag\nKein Wochenende" = "red",
  "Kein Feiertag\nWochenende" = "orange",
  "Feiertag\nWochenende" = "blue"
)

plot_histogram_by_group(
  cleaned_power_consum,
  group_name = "WorkdayHolidayWeekend",
  file_name = "plots\\workday_holiday_weekend_histogram.png",
  colors = whw_colors,
  x="PowerConsum",
  x_label = "Stromverbrauch [MW]",
  y_label = "Häufigkeit",
  name_0 = "Wochenende oder Feiertage",
  name_1 = "Werktag"
)


plot_histogram_by_group(
  cleaned_power_consum,
  group_name = "WorkDay",
  file_name = "plots\\workday_histogram.png",
  colors = working_colors,
  x="PowerConsum",
  x_label = "Stromverbrauch [MW]",
  y_label = "Häufigkeit",
  name_0 = "Wochenende oder Feiertage",
  name_1 = "Werktag"
)

plot_histogram_by_group(
  cleaned_power_consum,
  group_name = "Holiday",
  file_name = "plots\\holiday_histogram.png",
  colors = working_colors,
  x="PowerConsum",
  x_label = "Stromverbrauch [MW]",
  y_label = "Häufigkeit",
  name_0 = "Werktag oder Wochenende",
  name_1 = "Feiertag"
)

plot_histogram_by_group(
  cleaned_power_consum,
  group_name = "HolidayAndWorkDay",
  file_name = "plots\\holiday_workday_histogram.png",
  colors = working_colors,
  x="PowerConsum",
  x_label = "Stromverbrauch [MW]",
  y_label = "Häufigkeit",
  name_0 = "Wochenende oder Werktag",
  name_1 = "Feiertag am Werktag"
)

plot_by_group(
  cleaned_power_consum,
  group_name = "HolidayName",
  file_name = "plots\\holiday_boxplot.png",
  colors = local_name_colors,
  title = "Übersicht der einzelnen Feiertage",
  y="PowerConsum",
  y_label="Stromverbrauch [MW]",
  x_label="Jahre"
)

plot_by_group(
  cleaned_power_consum,
  group_name = "Weekday",
  file_name = "plots\\weekday_boxplot.png",
  colors = week_colors,
  title = "Übersicht der einzelnen Wochentage",
  y = "PowerConsum",
  y_label="Stromverbrauch [MW]",
  x_label="Jahre"
)

plot_by_group(
  cleaned_power_consum,
  group_name = "WorkDay",
  file_name = "plots\\workday_boxplot.png",
  colors = working_colors,
  title = "Übersicht, ob Feiertag (FALSE) oder Werktag (TRUE)",
  y = "PowerConsum",
  y_label="Stromverbrauch [MW]",
  x_label="Jahre"
)


plot_by_column(
  df = cleaned_power_consum,
  x = "Hour",
  y = "PowerConsum",
  x_label = "Stunden",
  y_label = "Stromverbrauch [MW]",
  file_name = "plots\\hour_boxplot.png",
  title = "Übersicht der einzelnen Stunden"
)

plot_by_column(
  df = cleaned_power_consum,
  x = "Month",
  y = "PowerConsum",
  x_label = "Monate",
  y_label = "Stromverbrauch [MW]",
  file_name = "plots\\month_boxplot.png",
  title = "Übersicht der einzelnen Monate"
)

plot_by_column(
  df = cleaned_power_consum,
  x = "Week",
  y = "PowerConsum",
  x_label = "Woche",
  y_label = "Stromverbrauch [MW]",
  file_name = "plots\\week_boxplot.png",
  title = "Übersicht der einzelnen Wochen"
)

plot_by_column(
  df = cleaned_power_consum,
  x = "Year",
  y = "PowerConsum",
  x_label = "Jahr",
  y_label = "Stromverbrauch [MW]",
  file_name = "plots\\year_boxplot.png",
  title = "Übersicht der einzelnen Jahre"
)

plot_year_month_week_day(
  df=cleaned_power_consum,
  date_column="DateIndex",
  y="PowerConsum",
  from_year=2015,
  to_year=2024,
  from_week=0,
  to_week=52,
  year_for_week=2018,
  from_day=1,
  to_day=30,
  month_for_day=4,
  year_for_day=2018,
  from_month=1,
  to_month=12,
  year_for_month=2018,
  holiday="Holiday",
  day_of_week = "Weekday"
)


```
# Train-Test dataset also Transformation

```{r, echo=TRUE, message=FALSE}

train_power_consum <- cleaned_power_consum |>
  filter(year(DateIndex) > 2018 & (year(DateIndex) < 2022))
```

# Fit

```{r, echo=TRUE, message=FALSE}

cleaned_power_consum |>
  model(STL(
    PowerConsum ~ season(period = 24 * 365.25)
    + season(period = 24 * 7)
    + season(period = 24),
    robust = TRUE 
  )) |>
  components() |>
  autoplot() + labs(x = "Observation")

lambda <- cleaned_power_consum |>
  features(PowerConsum, features = guerrero) |>
  pull(lambda_guerrero)
train_power_consum_transformed <- cleaned_power_consum |>
  mutate(PowerConsum = box_cox(PowerConsum, lambda))

train_power_consum_transformed |>
  gg_tsdisplay(PowerConsum, plot_type = "partial", lag = 100)

```

Starting Model

```{r, echo=TRUE, message=FALSE}

fit <- train_power_consum |>
  model(
    ARIMA = ARIMA(PowerConsum ~
            PDQ(0,0,0)
          + pdq(d=0)
          + WorkDay
          + Holiday
          + MeanLastWeek
          + MeanLastTwoDays
          + MaxLastOneDay
          + MinLastOneDay
          + LastDayWasHolodiayAndNotWeekend
          + NextDayIsHolidayAndNotWeekend
          + fourier(period = "day", K = 10)
          + fourier(period = "week", K = 5)
          + fourier(period = "year", K = 3)
          )
  )

saveRDS(fit, file = "model/arima_0_2021_2023.rds")
```

What if no Holiday after before effect

```{r, echo=TRUE, message=FALSE}

fit <- train_power_consum |>
  model(
    ARIMA = ARIMA(PowerConsum ~
            PDQ(0,0,0)
          + pdq(d=0)
          + WorkDay
          + Holiday
          + MeanLastWeek
          + MeanLastTwoDays
          + MaxLastOneDay
          + MinLastOneDay
          + fourier(period = "day", K = 10)
          + fourier(period = "week", K = 5)
          + fourier(period = "year", K = 3)
          )
  )

saveRDS(fit, file = "model/arima_1_2021_2023.rds")
```

What if period day 8 

```{r, echo=TRUE, message=FALSE}

fit <- train_power_consum |>
  model(
    ARIMA = ARIMA(PowerConsum ~
            PDQ(0,0,0)
          + pdq(d=0)
          + WorkDay
          + Holiday
          + MeanLastWeek
          + MeanLastTwoDays
          + MaxLastOneDay
          + MinLastOneDay
          + LastDayWasHolodiayAndNotWeekend
          + NextDayIsHolidayAndNotWeekend
          + fourier(period = "day", K = 8)
          + fourier(period = "week", K = 5)
          + fourier(period = "year", K = 3)
          )
  )

saveRDS(fit, file = "model/arima_2_2021_2023.rds")
```


```{r, echo=TRUE, message=FALSE}

fit <- train_power_consum |>
  model(
    ARIMA = ARIMA(PowerConsum ~
            PDQ(0,0,0)
          + pdq(d=0)
          + WorkDay
          + Holiday
          + LastDayWasHolodiayAndNotWeekend
          + NextDayIsHolidayAndNotWeekend
          + fourier(period = "day", K = 8)
          + fourier(period = "week", K = 5)
          + fourier(period = "year", K = 3)
          )
  )

saveRDS(fit, file = "model/arima_3_2021_2023.rds")
```

```{r, echo=TRUE, message=FALSE}

fit <- train_power_consum |>
  model(
    ARIMA = ARIMA(PowerConsum ~
            PDQ(0,0,0)
          + pdq(d=0)
          + WorkDay
          + Holiday
          + MeanLastWeek
          + MeanLastTwoDays
          + MaxLastOneDay
          + MinLastOneDay
          + LastDayWasHolodiayAndNotWeekend
          + NextDayIsHolidayAndNotWeekend
          + fourier(period = "day", K = 8)
          + fourier(period = "week", K = 5)
          + fourier(period = "year", K = 3)
          )
  )

saveRDS(fit, file = "model/arima_4_2021_2023.rds")
```


```{r, echo=TRUE, message=FALSE}
fit <- train_power_consum |>
  model(
    ARIMA = ARIMA(PowerConsum ~
            PDQ(0,0,0)
          + pdq(d=0)
          + WorkDay
          + Holiday
          + MeanLastWeek
          + MeanLastTwoDays
          + MaxLastOneDay
          + MinLastOneDay
          + LastDayWasHolodiayAndNotWeekend
          + NextDayIsHolidayAndNotWeekend
          + fourier(period = 24, K = 8)
          + fourier(period = 24*7, K = 5)
          + fourier(period = 24*365.25, K = 3)
          )
  )

saveRDS(fit, file = "model/arima_5_2021_2023.rds")
```


```{r, echo=TRUE, message=FALSE}

# /example/model/arima_1
fit <- train_power_consum |>
  model(
    TSLM = TSLM(PowerConsum ~
          WorkDay
          + Holiday
          + MeanLastWeek
          + MeanLastTwoDays
          + MaxLastOneDay
          + MinLastOneDay
          + LastDayWasHolodiayAndNotWeekend
          + NextDayIsHolidayAndNotWeekend
          + fourier(period = "day", K = 12)
          + fourier(period = "week", K = 24)
          + fourier(period = "year", K = 24)
          )
  )

saveRDS(fit, file = "model/tslm_0_2021_2023.rds")
```


```{r, echo=TRUE, message=FALSE}

fit <- train_power_consum |>
  model(
    Mean = MEAN(PowerConsum),
    )

saveRDS(fit, file = "model/mean_2021_2023.rds")   

fit <- train_power_consum |>
  model(
    Naive = NAIVE(PowerConsum),
    Drift = NAIVE(PowerConsum ~ drift())
    ) 

saveRDS(fit, file = "model/naive_2021_2023.rds")  

fit <- train_power_consum |>
  model(
    Drift = NAIVE(PowerConsum ~ drift())
    ) 

saveRDS(fit, file = "model/drift_2021_2023.rds")  
```

```{r, echo=TRUE, message=FALSE}

fit <- train_power_consum |>
  model(
    PROPHET = prophet(
      PowerConsum ~ 
        MeanLastWeek
      + MeanLastTwoDays
      + MaxLastOneDay
      + MinLastOneDay
      + WorkDay 
      + Holiday
      + LastDayWasHolodiayAndNotWeekend
      + NextDayIsHolidayAndNotWeekend
      + season(period = "day", order = 24) 
      + season(period = "week", order = 5) 
      + season(period = "year", order = 3))
    )

saveRDS(fit, file = "model/prophet_0_2021_2023.rds")    
```


```{r, echo=TRUE, message=FALSE}

fit <- train_power_consum |>
  model(
    ARIMA = ARIMA(PowerConsum ~
            PDQ(0,0,0)
          + pdq(d=0)
          + WorkDay
          + Holiday
          + MeanLastWeek
          + MeanLastTwoDays
          + MaxLastOneDay
          + MinLastOneDay
          + LastDayWasHolodiayAndNotWeekend
          + NextDayIsHolidayAndNotWeekend
          + fourier(period = 24, K = 8)
          + fourier(period = 24*7, K = 5)
          + fourier(period = 24*365.25, K = 3),
          stepwise=FALSE,
          greedy=FALSE,
          approx=FALSE
          )
  )


saveRDS(fit, file = "model/arima_6_2021_2023.rds")
```

```{r, echo=TRUE, message=FALSE}
fit <- train_power_consum |>
  model(
    ARIMA = ARIMA(PowerConsum ~
            PDQ(0,0,0)
          + pdq(d=0)
          + MeanLastWeek
          + MeanLastTwoDays
          + MaxLastOneDay
          + MinLastOneDay
          + LastDayWasHolodiayAndNotWeekend
          + NextDayIsHolidayAndNotWeekend
          + WorkDay 
          + fourier(period = 24, K = 4)
          + fourier(period = 24*7, K = 3)
          + fourier(period = 24*365.25, K = 2)
          )
  )
saveRDS(fit, file = "model/arima_7_2021_2023.rds")
```

```{r, echo=TRUE, message=FALSE}

fit <- train_power_consum |>
  model(
    ARIMA = ARIMA(PowerConsum ~
            PDQ(0,0,0)
          + pdq(d=0)
          + MeanLastWeek
          + MeanLastTwoDays
          + MaxLastOneDay
          + MinLastOneDay
          + LastDayWasHolodiayAndNotWeekend
          + NextDayIsHolidayAndNotWeekend
          + WorkDay 
          + Holiday
          + fourier(period = 24, K = 8)
          + fourier(period = 24*7, K = 5)
          # + fourier(period = 24*365.25, K = 3)
          )
  )
saveRDS(fit, file = "model/arima_8_2021_2023.rds")
```


```{r, echo=TRUE, message=FALSE}

fit <- train_power_consum |>
  model(
    ARIMA = ARIMA(PowerConsum ~
            PDQ(0,0,0)
          + pdq(d=0)
          + WorkDay
          + Holiday
          + MeanLastWeek
          + MeanLastTwoDays
          + MaxLastOneDay
          + MinLastOneDay
          + LastDayWasHolodiayAndNotWeekend
          + NextDayIsHolidayAndNotWeekend
          + fourier(period = "day", K = 6)
          + fourier(period = "week", K = 5)
          + fourier(period = "year", K = 3)
          )
  )

saveRDS(fit, file = "model/arima_9_2021_2023.rds")
```

```{r, echo=TRUE, message=FALSE}

fit <- train_power_consum |>
  model(
    ARIMA = ARIMA(PowerConsum ~
            PDQ(0,0,0)
          + pdq(d=0)
          + WorkDay
          + Holiday
          + MeanLastWeek
          + MeanLastTwoDays
          + MaxLastOneDay
          + MinLastOneDay
          + LastDayWasHolodiayAndNotWeekend
          + NextDayIsHolidayAndNotWeekend
          + fourier(period = "day", K = 4)
          + fourier(period = "week", K = 5)
          + fourier(period = "year", K = 3)
          )
  )

saveRDS(fit, file = "model/arima_10_2021_2023.rds")
```

```{r, echo=TRUE, message=FALSE}

fit <- train_power_consum |>
  model(
    ARIMA = ARIMA(PowerConsum ~
            PDQ(0,0,0)
          + pdq(d=0)
          + WorkDay
          + Holiday
          + MeanLastWeek
          + MeanLastTwoDays
          + MaxLastOneDay
          + MinLastOneDay
          + LastDayWasHolodiayAndNotWeekend
          + NextDayIsHolidayAndNotWeekend
          + fourier(period = "day", K = 2)
          + fourier(period = "week", K = 5)
          + fourier(period = "year", K = 3)
          )
  )

saveRDS(fit, file = "model/arima_11_2021_2023.rds")
```

```{r, echo=TRUE, message=FALSE}

fit <- train_power_consum |>
  model(
    ARIMA = ARIMA(PowerConsum ~
            PDQ(0,0,0)
          + pdq(d=0)
          + WorkDay
          + Holiday
          + MeanLastWeek
          + MeanLastTwoDays
          + MaxLastOneDay
          + MinLastOneDay
          + LastDayWasHolodiayAndNotWeekend
          + NextDayIsHolidayAndNotWeekend
          + fourier(period = "day", K = 8)
          + fourier(period = "week", K = 3)
          + fourier(period = "year", K = 3)
          )
  )

saveRDS(fit, file = "model/arima_12_2021_2023.rds")
```

```{r, echo=TRUE, message=FALSE}

fit <- train_power_consum |>
  model(
    ARIMA = ARIMA(PowerConsum ~
            PDQ(0,0,0)
          + pdq(d=0)
          + WorkDay
          + Holiday
          + MeanLastWeek
          + MeanLastTwoDays
          + MaxLastOneDay
          + MinLastOneDay
          + LastDayWasHolodiayAndNotWeekend
          + NextDayIsHolidayAndNotWeekend
          + fourier(period = "day", K = 8)
          + fourier(period = "week", K = 5)
          + fourier(period = "year", K = 1)
          )
  )

saveRDS(fit, file = "model/arima_13_2021_2023.rds")
```

```{r, echo=TRUE, message=FALSE}

fit <- train_power_consum |>
  model(
    ARIMA = ARIMA(PowerConsum ~
            PDQ(0,0,0)
          + pdq(d=0)
          + WorkDay
          + Holiday
          + MeanLastWeek
          + MeanLastTwoDays
          + MaxLastOneDay
          + MinLastOneDay
          + LastDayWasHolodiayAndNotWeekend
          + NextDayIsHolidayAndNotWeekend
          + fourier(period = "day", K = 6)
          + fourier(period = "week", K = 7)
          + fourier(period = "year", K = 3)
          )
  )

saveRDS(fit, file = "model/arima_14_2021_2023.rds")
```

```{r, echo=TRUE, message=FALSE}

fit <- train_power_consum |>
  model(
    ARIMA = ARIMA(PowerConsum ~
            PDQ(0,0,0)
          + pdq(d=0)
          + WorkDay
          + Holiday
          + MeanLastWeek
          + MeanLastTwoDays
          + MaxLastOneDay
          + MinLastOneDay
          + LastDayWasHolodiayAndNotWeekend
          + NextDayIsHolidayAndNotWeekend
          + fourier(period = "day", K = 6)
          + fourier(period = "week", K = 9)
          + fourier(period = "year", K = 3)
          )
  )

saveRDS(fit, file = "model/arima_15_2021_2023.rds")
```


```{r, echo=TRUE, message=FALSE}

fit <- train_power_consum |>
  model(
    ARIMA = ARIMA(PowerConsum ~
            PDQ(0,0,0)
          + pdq(d=0)
          + WorkDay
          + Holiday
          + MeanLastWeek
          + MeanLastTwoDays
          + MaxLastOneDay
          + MinLastOneDay
          + LastDayWasHolodiayAndNotWeekend
          + NextDayIsHolidayAndNotWeekend
          + fourier(period = "day", K = 6)
          + fourier(period = "week", K = 5)
          + fourier(period = "year", K = 5)
          )
  )

saveRDS(fit, file = "model/arima_16_2021_2023.rds")
```


```{r, echo=TRUE, message=FALSE}

fit <- train_power_consum |>
  model(
    ARIMA = ARIMA(PowerConsum ~
            PDQ(0,0,0)
          + pdq(d=0)
          + WorkDay
          + Holiday
          + MeanLastWeek
          + MeanLastTwoDays
          + MaxLastOneDay
          + MinLastOneDay
          + LastDayWasHolodiayAndNotWeekend
          + NextDayIsHolidayAndNotWeekend
          + fourier(period = "day", K = 10)
          + fourier(period = "week", K = 5)
          + fourier(period = "year", K = 3)
          )
  )

saveRDS(fit, file = "model/arima_17_2021_2023.rds")
```

```{r, echo=TRUE, message=FALSE}

fit <- train_power_consum |>
  model(
    ARIMA = ARIMA(PowerConsum ~
            PDQ(0,0,0)
          + pdq(d=0)
          + WorkDay
          + Holiday
          + MeanLastWeek
          + MeanLastTwoDays
          + MaxLastOneDay
          + MinLastOneDay
          + LastDayWasHolodiayAndNotWeekend
          + NextDayIsHolidayAndNotWeekend
          + fourier(period = "day", K = 6)
          + fourier(period = "week", K = 7)
          + fourier(period = "year", K = 3)
          )
  )

saveRDS(fit, file = "model/arima_18_2021_2023.rds")
```

```{r, echo=TRUE, message=FALSE}

fit <- train_power_consum |>
  model(
    PROPHET = prophet(
      PowerConsum ~ 
        MeanLastWeek
      + MeanLastTwoDays
      + MaxLastOneDay
      + MinLastOneDay
      + WorkDay 
      + Holiday
      + LastDayWasHolodiayAndNotWeekend
      + NextDayIsHolidayAndNotWeekend
      + season(period = "day", order = 24) 
      + season(period = "week", order = 5) 
      + season(period = "year", order = 3))
    )

saveRDS(fit, file = "model/prophet_1_2021_2023.rds")    
```

```{r, echo=TRUE, message=FALSE}

holiday_effect_model <- lm(
  PowerConsum ~
  Holiday,
  data = train_power_consum
)

saveRDS(holiday_effect_model, file = "ensemble_model/version_0/holiday_effect_2021_2023.rds") 

train_power_consum$Residuals <- residuals(holiday_effect_model)

fit <- train_power_consum |>
  model(
    ARIMA = ARIMA(Residuals ~
            PDQ(0,0,0)
          + pdq(d=0)
          + MeanLastWeek
          + WorkDay
          + EndOfTheYear # new
          + FirstWeekOfTheYear # new
          + MeanLastTwoDays 
          + MaxLastOneDay
          + MinLastOneDay
          + fourier(period = "day", K = 6)
          + fourier(period = "week", K = 7)
          + fourier(period = "year", K = 3)
          )
  )

saveRDS(fit, file = "ensemble_model/version_0/arima_2021_2023.rds") 

```

```{r, echo=TRUE, message=FALSE}

# Combined Model LN with Holiday Effect and

holiday_effect_model <- lm(
  PowerConsum ~
  WorkDay
  + EndOfTheYear
  + FirstWeekOfTheYear,
  data = train_power_consum
)

saveRDS(holiday_effect_model, file = "ensemble_model/version_1/holiday_effect_2021_2023.rds") 

train_power_consum$Residuals <- residuals(holiday_effect_model)

fit <- train_power_consum |>
  model(
    ARIMA = ARIMA(Residuals ~
            PDQ(0,0,0)
          + pdq(d=0)
          + WorkDay
          + MeanLastWeek
          + MeanLastTwoDays 
          + MaxLastOneDay
          + MinLastOneDay
          + fourier(period = "day", K = 6)
          + fourier(period = "week", K = 7)
          + fourier(period = "year", K = 3)
          )
  )

saveRDS(fit, file = "ensemble_model/version_1/arima_2021_2023.rds") 

```

```{r, echo=TRUE, message=FALSE}


if (!dir.exists("ensemble_model/version_2")) {
  dir.create("ensemble_model/version_2")
}

holiday_effect_model <- lm(
  PowerConsum ~
  WorkDay,
  data = train_power_consum
)

saveRDS(holiday_effect_model, file = "ensemble_model/version_2/holiday_effect_2021_2023.rds") 

train_power_consum$Residuals <- residuals(holiday_effect_model)

fit <- train_power_consum |>
  model(
    ARIMA = ARIMA(Residuals ~
            PDQ(0,0,0)
          + pdq(d=0)
          + MeanLastWeek
          + MeanLastTwoDays 
          + MaxLastOneDay
          + MinLastOneDay
          + EndOfTheYear
          + FirstWeekOfTheYear
          + fourier(period = "day", K = 6)
          + fourier(period = "week", K = 7)
          + fourier(period = "year", K = 3)
          )
  )

saveRDS(fit, file = "ensemble_model/version_2/arima_2021_2023.rds") 

```

```{r, echo=TRUE, message=FALSE}

if (!dir.exists("ensemble_model/version_3")) {
  dir.create("ensemble_model/version_3")
}

holiday_effect_model <- lm(PowerConsum ~
                             MeanLastTwoDays
                           + MaxLastOneDay
                           + MeanLastWeek
                           + MinLastOneDay,
                           data = train_power_consum)

saveRDS(holiday_effect_model, file = "ensemble_model/version_3/holiday_effect_2021_2023.rds") 

train_power_consum$Residuals <- residuals(holiday_effect_model)

fit <- train_power_consum |>
  model(
    ARIMA = ARIMA(Residuals ~
            PDQ(0,0,0)
          + pdq(d=0)
          + Holiday
          + WorkDay
          + EndOfTheYear
          + FirstWeekOfTheYear
          + fourier(period = "day", K = 6)
          + fourier(period = "week", K = 7)
          + fourier(period = "year", K = 3)
          )
  )

saveRDS(fit, file = "ensemble_model/version_3/arima_2021_2023.rds") 

```

```{r, echo=TRUE, message=FALSE}

if (!dir.exists("ensemble_model/version_4")) {
  dir.create("ensemble_model/version_4")
}

holiday_effect_model <- lm(
  PowerConsum ~
  Holiday 
  + WorkDay,
  data = train_power_consum
)

saveRDS(holiday_effect_model, file = "ensemble_model/version_4/holiday_effect_2021_2023.rds") 

train_power_consum$Residuals <- residuals(holiday_effect_model)

fit <- train_power_consum |>
  model(
    ARIMA = ARIMA(Residuals ~
            PDQ(0,0,0)
          + pdq(d=0)
          + MeanLastWeek
          + EndOfTheYear 
          + FirstWeekOfTheYear 
          + MeanLastTwoDays 
          + MaxLastOneDay
          + MinLastOneDay
          + fourier(period = "day", K = 6)
          + fourier(period = "week", K = 7)
          + fourier(period = "year", K = 3)
          )
  )

saveRDS(fit, file = "ensemble_model/version_4/arima_2021_2023.rds") 

```

```{r, echo=TRUE, message=FALSE}

if (!dir.exists("ensemble_model/version_5")) {
  dir.create("ensemble_model/version_5")
}


train_power_consum_v5 <- train_power_consum |>
  mutate(HolidaySmoothed = Holiday + sin(2 * pi * (as.numeric(Hour)+1) / 24))

holiday_effect_model <- lm(
  PowerConsum ~
  HolidaySmoothed,
  data = train_power_consum_v5
)

saveRDS(holiday_effect_model, file = "ensemble_model/version_5/holiday_effect_2021_2023.rds") 

train_power_consum_v5$Residuals <- residuals(holiday_effect_model)

fit <- train_power_consum_v5 |>
  model(
    ARIMA = ARIMA(Residuals ~
            PDQ(0,0,0)
          + pdq(d=0)
          + MeanLastWeek
          + WorkDay
          + EndOfTheYear # new
          + FirstWeekOfTheYear # new
          + MeanLastTwoDays
          + MaxLastOneDay
          + MinLastOneDay
          + fourier(period = "day", K = 6)
          + fourier(period = "week", K = 7)
          + fourier(period = "year", K = 3)
          )
  )

saveRDS(fit, file = "ensemble_model/version_5/arima_2021_2023.rds")

rm(train_power_consum_v5)

```

```{r, echo=TRUE, message=FALSE}

if (!dir.exists("ensemble_model/version_6")) {
  dir.create("ensemble_model/version_6")
}


holiday_effect_model <- lm(
  PowerConsum ~
  HolidaySmoothed,
  data = train_power_consum
)

saveRDS(holiday_effect_model, file = "ensemble_model/version_6/holiday_effect_2021_2023.rds") 

train_power_consum$Residuals <- residuals(holiday_effect_model)

fit <- train_power_consum |>
  model(
    ARIMA = ARIMA(Residuals ~
            PDQ(0,0,0)
          + pdq(d=0)
          + MeanLastWeek
          + WorkDay
          + EndOfTheYear # new
          + FirstWeekOfTheYear # new
          + MeanLastTwoDays
          + MaxLastOneDay
          + MinLastOneDay
          + fourier(period = "day", K = 6)
          + fourier(period = "week", K = 7)
          + fourier(period = "year", K = 3)
          )
  )

saveRDS(fit, file = "ensemble_model/version_6/arima_2021_2023.rds")

```

```{r, echo=TRUE, message=FALSE}

if (!dir.exists("ensemble_model/version_7")) {
  dir.create("ensemble_model/version_7")
}

train_power_consum_v7 <- train_power_consum |>
  mutate(HolidaySmoothed = Holiday + 0.5*sin(2 * pi * (as.numeric(Hour)+1) / 24))

holiday_effect_model <- lm(
  PowerConsum ~
  HolidaySmoothed,
  data = train_power_consum_v7
)

saveRDS(holiday_effect_model, file = "ensemble_model/version_7/holiday_effect_2021_2023.rds") 

train_power_consum_v7$Residuals <- residuals(holiday_effect_model)

fit <- train_power_consum_v7 |>
  model(
    ARIMA = ARIMA(Residuals ~
            PDQ(0,0,0)
          + pdq(d=0)
          + MeanLastWeek
          + WorkDay
          + EndOfTheYear # new
          + FirstWeekOfTheYear # new
          + MeanLastTwoDays
          + MaxLastOneDay
          + MinLastOneDay
          + fourier(period = "day", K = 6)
          + fourier(period = "week", K = 7)
          + fourier(period = "year", K = 3)
          )
  )

saveRDS(fit, file = "ensemble_model/version_7/arima_2021_2023.rds")

rm(train_power_consum_v7)

```

```{r, echo=TRUE, message=FALSE}

if (!dir.exists("ensemble_model/version_8")) {
  dir.create("ensemble_model/version_8")
}

train_power_consum_v8 <- train_power_consum |>
  mutate(HolidaySmoothed =  HolidayExtended + 0.5*sin(2 * pi * (as.numeric(Hour)+1) / 24))

holiday_effect_model <- lm(
  PowerConsum ~
  HolidaySmoothed,
  data = train_power_consum_v8
)

saveRDS(holiday_effect_model, file = "ensemble_model/version_8/holiday_effect_2021_2023.rds") 

train_power_consum_v8$Residuals <- residuals(holiday_effect_model)

fit <- train_power_consum_v8 |>
  model(
    ARIMA = ARIMA(Residuals ~
            PDQ(0,0,0)
          + pdq(d=0)
          + MeanLastWeek
          + WorkDay
          + EndOfTheYear # new
          + FirstWeekOfTheYear # new
          + MeanLastTwoDays
          + MaxLastOneDay
          + MinLastOneDay
          + fourier(period = "day", K = 6)
          + fourier(period = "week", K = 7)
          + fourier(period = "year", K = 3)
          )
  )

saveRDS(fit, file = "ensemble_model/version_8/arima_2021_2023.rds")

rm(train_power_consum_v8)

```

```{r, echo=TRUE, message=FALSE}

if (!dir.exists("ensemble_model/version_9")) {
  dir.create("ensemble_model/version_9")
}

train_power_consum_v9 <- train_power_consum |>
  mutate(HolidaySmoothed =  Holiday + 0.25*sin(2 * pi * (as.numeric(Hour)+1) / 24))

holiday_effect_model <- lm(
  PowerConsum ~
  HolidaySmoothed,
  data = train_power_consum_v9
)

saveRDS(holiday_effect_model, file = "ensemble_model/version_9/holiday_effect_2021_2023.rds") 

train_power_consum_v9$Residuals <- residuals(holiday_effect_model)

fit <- train_power_consum_v9 |>
  model(
    ARIMA = ARIMA(Residuals ~
            PDQ(0,0,0)
          + pdq(d=0)
          + MeanLastWeek
          + WorkDay
          + EndOfTheYear # new
          + FirstWeekOfTheYear # new
          + MeanLastTwoDays
          + MaxLastOneDay
          + MinLastOneDay
          + fourier(period = "day", K = 6)
          + fourier(period = "week", K = 7)
          + fourier(period = "year", K = 3)
          )
  )

saveRDS(fit, file = "ensemble_model/version_9/arima_2021_2023.rds")

rm(train_power_consum_v9)

```

```{r, echo=TRUE, message=FALSE}

if (!dir.exists("ensemble_model/version_10")) {
  dir.create("ensemble_model/version_10")
}


train_power_consum_v10 <- train_power_consum |>
  mutate(HolidaySmoothed = Holiday + sin(2 * pi * (as.numeric(Hour)+1) / 24))

holiday_effect_model <- lm(
  PowerConsum ~
  HolidaySmoothed,
  data = train_power_consum_v10
)

saveRDS(holiday_effect_model, file = "ensemble_model/version_10/holiday_effect_2020_2022.rds") 

train_power_consum_v10$Residuals <- residuals(holiday_effect_model)

fit <- train_power_consum_v10 |>
  model(
    ARIMA = ARIMA(Residuals ~
            PDQ(0,0,0)
          + pdq(d=0)
          + MeanLastWeek
          + WorkDay
          + EndOfTheYear # new
          + FirstWeekOfTheYear # new
          + MeanLastTwoDays
          + MaxLastOneDay
          + MinLastOneDay
          + fourier(period = "day", K = 6)
          + fourier(period = "week", K = 7)
          + fourier(period = "year", K = 3)
          )
  )

saveRDS(fit, file = "ensemble_model/version_10/arima_2020_2022.rds")

rm(train_power_consum_v10)

```

```{r, echo=TRUE, message=FALSE}

if (!dir.exists("ensemble_model/version_11")) {
  dir.create("ensemble_model/version_11")
}


train_power_consum_v10 <- train_power_consum |>
  mutate(HolidaySmoothed = Holiday + sin(2 * pi * (as.numeric(Hour)+1) / 24))

holiday_effect_model <- lm(
  PowerConsum ~
  HolidaySmoothed,
  data = train_power_consum_v10
)

saveRDS(holiday_effect_model, file = "ensemble_model/version_11/holiday_effect_2019_2021.rds") 

train_power_consum_v10$Residuals <- residuals(holiday_effect_model)

fit <- train_power_consum_v10 |>
  model(
    ARIMA = ARIMA(Residuals ~
            PDQ(0,0,0)
          + pdq(d=0)
          + MeanLastWeek
          + WorkDay
          + EndOfTheYear # new
          + FirstWeekOfTheYear # new
          + MeanLastTwoDays
          + MaxLastOneDay
          + MinLastOneDay
          + fourier(period = "day", K = 6)
          + fourier(period = "week", K = 7)
          + fourier(period = "year", K = 3)
          )
  )

saveRDS(fit, file = "ensemble_model/version_11/arima_2019_2021.rds")

rm(train_power_consum_v10)

```

# Load All Models and Metrics Evaluation



```{r, echo=TRUE, message=FALSE}
load_all()

ensembled_fc <- load_ensembled_models(
  days_to_forecast = 40,
  months_to_forecast = 6,
  year_to_forecast = 2024,
  starting_month = 1,
  real_data = cleaned_power_consum,
  smard_fc = cleaned_smard_pred
)
all_forecasts_ensembled <- ensembled_fc$all_forecasts
raw_fc_ensembled <- ensembled_fc$raw_forecasts

fc <- load_all_model_results(
  days_to_forecast = 40,
  months_to_forecast = 6,
  year_to_forecast = 2024,
  starting_month = 1,
  smard_fc = cleaned_smard_pred,
  real_data = cleaned_power_consum
)

all_forecasts <- fc$combined_forecasts
raw_fc <- fc$raw_forecasts
# all_fits <- fc$all_fits
```


```{r, echo=TRUE, message=FALSE}
load_all()
metric_results <- calculate_metrics(fc_data = all_forecasts, fc_data_ensembled=all_forecasts_ensembled)

rm(fc)

name_of_best_model <- plot_forecast(
  all_forecasts = all_forecasts,
  metric_results = metric_results,
  cleaned_power_consum = cleaned_power_consum,
  raw_fc = raw_fc,
  month_to_plot = 1,
  days_to_plot = 40
)

name_of_best_model <- plot_forecast_ensembled(
  all_forecasts = all_forecasts_ensembled,
  metric_results = metric_results,
  cleaned_power_consum = cleaned_power_consum,
  month_to_plot = 1,
  days_to_plot = 15
)
```

```{r, echo=TRUE, message=FALSE}
load_all()
all_forecasts_ensembled_v_filter <- all_forecasts_ensembled |>
  filter(.model == "version_5" | .model == "SMARD") |>
  mutate(.res = PowerConsum - .mean)

best_forecast <- all_forecasts_ensembled_v_filter |>
  filter(.model == "version_5") 
ggplot(best_forecast, aes(x=DateIndex, y=.res)) + 
  geom_line()

ggplot(best_forecast, aes(x=.res)) + 
  geom_histogram()

best_forecast |>
  as_tsibble(index=DateIndex) |>
  gg_tsdisplay(.res, plot_type = "partial", lag = 100)

smard_fc <- all_forecasts_ensembled_v_filter |>
  filter(.model == "SMARD")

ggplot(smard_fc, aes(x=DateIndex, y=.res)) + 
  geom_line()

ggplot(smard_fc, aes(x=.res)) + 
  geom_histogram()

smard_fc |>
  as_tsibble(index=DateIndex) |>
  gg_tsdisplay(.res, plot_type = "partial", lag = 100)

```

```{r, echo=TRUE, message=FALSE}
load_all()
train_power_consum_converted <- train_power_consum |>
  mutate(HolidayExtended = lag(Holiday, 6, default=0) + Holiday,
         HolidayExtended = ifelse(HolidayExtended == 2, 1, HolidayExtended),
         HolidaySmoothed = Holiday + sin(2 * pi * (as.numeric(Hour)+1) / 24))
 
holiday_effect_model <- lm(
  PowerConsum ~
  HolidaySmoothed,
  data = train_power_consum_converted
)
test_data <- load_test_data(model_name="version_5", 
                            transformed_power_consum = cleaned_power_consum)

filtered_test_data <- test_data |>
  filter(year(DateIndex) == 2024) |> 
  filter(month(DateIndex) >= 1) |> 
  filter(month(DateIndex) <= 6) |>
  filter(day(DateIndex) < 40) |>
  mutate(HolidayExtended = lag(Holiday, 6, default=0) + Holiday,
         HolidayExtended = ifelse(HolidayExtended == 2, 1, HolidayExtended),
         HolidaySmoothed = HolidayExtended + 0.5*sin(2 * pi * (as.numeric(Hour)+1) / 24)) |>
  as_tsibble()

raw_fc_holiday <- predict(holiday_effect_model, newdata = filtered_test_data)

fc_v0_linear <- raw_fc_ensembled[["ensemble_model/version_5/holiday_effect_2021_2023.rds"]]
fc_v0_arima <- raw_fc_ensembled[["ensemble_model/version_5/arima_2021_2023.rds"]]
fc_v0_arima$linear_fc <- raw_fc_holiday
fc_v0_arima$linear_fc_before <- fc_v0_linear


fc_v0_arima <- fc_v0_arima |>
  filter(month(DateIndex) == 1)


p <- ggplot(fc_v0_arima, aes(x=DateIndex)) +
  geom_line(aes(y = PowerConsum, color = "PowerConsum")) +
  geom_line(aes(y = linear_fc, color = "Linear FC")) +
  geom_line(aes(y = linear_fc_before - PowerConsum, color = "Linear FCBF")) +
  scale_color_manual(
    name = "Legend",
    values = c(
      "PowerConsum" = "red",
      "Linear FC" = "darkgreen",
      "Linear FC" = "blue"
    )
  )

p

fit_arima <- readRDS("ensemble_model/version_5/arima_2021_2023.rds")
```


