
```{r setup, include=FALSE}

# Load Packages
library(fhswf)
library(ggplot2)
library(tsibbledata) #0.4.1
library(dplyr)
library(tsibble)
library(fable)
library(fabletools)
library(feasts)
library(distributional)
library(lubridate)
library(broom)
library(readr)
library(tidyr)
library(datasets)
library(forecast)
library(timeDate)
library(qlcal)
library(devtools)
library(zoo)
library(corrplot)
library(scales)
library(fable.prophet)
load_all()
# devtools::document()
```


# Notizen

- Erwähnen von Saisonallen Pattern für stündliche Daten meisten Täglich, Wöchentlich und jährlich

# Define data-paths and load german holidays

```{r, echo=TRUE, message=FALSE}

# Define datapaths
power_consum_path <- "dataset\\stunde_2015_2024\\Realisierter_Stromverbrauch_201501010000_202407090000_Stunde.csv"
power_generation_path <- "dataset\\stunde_2015_2024\\Realisierte_Erzeugung_201501010000_202407090000_Stunde.csv"
power_consum_smard_prediction_path <- "dataset\\propgnose_vom_smard\\Prognostizierter_Stromverbrauch_202401010000_202407090000_Stunde.csv"

```

```{r, echo=TRUE, message=FALSE}

# Load german holidays from 2015 to 2024
german_holidays <- load_german_holidays(from_year = 2015, to_year = 2024, location="/DE")
german_holidays <- german_holidays |> 
  mutate(date = as.Date(date)) |>
  select(localName, date)
```


# Load and cleanup power-consum, filling gaps and droping duplicates, keeping first value. 

```{r, echo=TRUE, message=FALSE}

load_power_consum <- function(path) {
  raw_power_consum <- read.csv2(file = path)
  
  names(raw_power_consum)[names(raw_power_consum) == "Datum.von"] <- "DateFrom"
  names(raw_power_consum)[names(raw_power_consum) == "Gesamt..Netzlast...MWh..Berechnete.Auflösungen"] <- "PowerConsum"
  
  raw_power_consum <-  raw_power_consum |>
    select(DateFrom, PowerConsum) |>
    mutate(PowerConsum = as.numeric(gsub(",", ".", gsub("\\.", "", PowerConsum))),
           DateFrom = dmy_hm(DateFrom))
  
  cleaned_power_consum <- raw_power_consum |>
    distinct(DateFrom, .keep_all = TRUE) |>
    mutate(DateIndex = DateFrom) |>
    as_tsibble(index = DateIndex) |>
    select(DateFrom, PowerConsum) |>
    fill_gaps() |>
    fill(PowerConsum, .direction = "downup") |>
    mutate(
      Weekday = wday(DateIndex, label = TRUE),  
      Date = as.Date(DateIndex),
      Year = as.factor(year(DateIndex)),
      Week = as.factor(week(DateIndex)),
      Hour = as.factor(hour(DateIndex)),
      Month = as.factor(month(DateIndex)),
    ) |>
    left_join(german_holidays, by = c("Date" = "date")) |>
    mutate(
      WorkDay = ifelse(!(Date %in% german_holidays$date | Weekday %in% c("Sa", "So")), 1, 0),
      Mo = Weekday == "Mo",
      Di = Weekday == "Di",  
      Mi = Weekday == "Mi",  
      Do = Weekday == "Do",  
      Fr = Weekday == "Fr",  
      Sa = Weekday == "Sa",  
      So = Weekday == "So",
      Holiday = ifelse(Date %in% german_holidays$date, 1, 0),
      LastDayWasNotWorkDay = !lag(WorkDay, n=24),
      LastDayWasNotWorkDayAndNowWorkDay = (LastDayWasNotWorkDay & WorkDay),
      NextDayIsNotWorkDayAndNowWorkDay= (WorkDay & !lead(WorkDay, n=24)),
      LastDayWasHolodiayAndNotWeekend = lag(Holiday, n=24) & !Sa & !So,
      NextDayIsHolidayAndNotWeekend = lead(Holiday, n=24) & !lead(Sa, n=24) & !lead(So, n=24),
      HolidayName = ifelse(is.na(localName), "Regulärer Tag", localName)
    )
  
  cleaned_power_consum |>
    gg_tsdisplay(PowerConsum, plot_type = "partial", lag = 400)
  
  
  
  raw_power_consum <- raw_power_consum |>
    arrange(DateFrom) |>
    mutate(
      MissingValue = difftime(DateFrom, lag(DateFrom, default = first(DateFrom)), units = "hours") == 2,
      DuplicatedDate = duplicated(DateFrom),
      Year = year(DateFrom)
    )
  
  plot_raw_data(
    df = raw_power_consum,
    x = "DateFrom",
    y = "PowerConsum",
    color = "DuplicatedDate",
    missing_value = "MissingValue",
    file_name = "plots\\raw_power_consum.png"
  )
  
  return(list(raw_power_consum = raw_power_consum, cleaned_power_consum = cleaned_power_consum))
}

power_consum_smard_prediction_loaded <- load_power_consum(power_consum_smard_prediction_path)
raw_power_consum_smard_prediction <- power_consum_smard_prediction_loaded$raw_power_consum
cleaned_power_consum_smard_prediction <- power_consum_smard_prediction_loaded$cleaned_power_consum

cleaned_power_consum_smard_prediction <- cleaned_power_consum_smard_prediction |>
  mutate(.model = "SMARD")
names(cleaned_power_consum_smard_prediction)[names(cleaned_power_consum_smard_prediction) == "PowerConsum"] <- ".mean"

power_consum_loaded <- load_power_consum(power_consum_path)
raw_power_consum <- power_consum_loaded$raw_power_consum
cleaned_power_consum <- power_consum_loaded$cleaned_power_consum




```

# Generate new Features

```{r, echo=TRUE, message=FALSE}

cleaned_power_consum$localName[is.na(cleaned_power_consum$localName)] = "Working-Day"

cleaned_power_consum$MeanLastWeek <- rollapply(cleaned_power_consum$PowerConsum, width = 24*7, FUN = function(x) mean(x[1:(24*7-1)]), align = "right", fill = NA) 

cleaned_power_consum$MeanLastTwoDays <- rollapply(cleaned_power_consum$PowerConsum, width = 24*2, FUN = function(x) mean(x[1:(24*2-1)]), align = "right", fill = NA) 

cleaned_power_consum$MaxLastOneDay <- rollapply(cleaned_power_consum$PowerConsum, width = 24*1, FUN = function(x) max(x[1:(24*1-1)]), align = "right", fill = NA) 

cleaned_power_consum$MinLastOneDay <- rollapply(cleaned_power_consum$PowerConsum, width = 24*1, FUN = function(x) min(x[1:(24*1-1)]), align = "right", fill = NA) 


cor <- cor(cleaned_power_consum[sapply(cleaned_power_consum, is.numeric)], method = c("pearson", "kendall", "spearman"), use = "complete.obs")

```



# Create different Plot for analysis

```{r echo=TRUE, message=FALSE}
load_all()
local_name_colors <- c(
  "Christi Himmelfahrt" = palette()[2],
  "Erster Weihnachtstag" = palette()[2],
  "Karfreitag" = palette()[2],
  "Neujahr" = palette()[2],
  "Ostermontag" = palette()[2],
  "Pfingstmontag" = palette()[2],
  "Reformationstag" = palette()[2],
  "Tag der Arbeit" = palette()[2],
  "Tag der Deutschen Einheit" = palette()[2],
  "Zweiter Weihnachtstag" = palette()[2],
  "Regulärer Tag" = palette()[1]
)


week_colors <- c(
  "Mo" = palette()[1],
  "Di" = palette()[1],
  "Mi" = palette()[1],
  "Do" = palette()[1],
  "Fr" = palette()[1],
  "Sa" = palette()[2],
  "So" = palette()[2]
)

working_colors <- c("TRUE" = palette()[1], "FALSE" = palette()[2])

plot_histogram_by_group(
  cleaned_power_consum,
  group_name = "WorkDay",
  file_name = "plots\\workday_histogram.png",
  colors = working_colors,
  x="PowerConsum",
  x_label = "Stromverbrauch [MW]",
  y_label = "Häufigkeit"
)

plot_histogram_by_group(
  cleaned_power_consum,
  group_name = "WorkDay",
  file_name = "plots\\workday_histogram.png",
  colors = working_colors,
  x="PowerConsum",
  x_label = "Stromverbrauch [MW]",
  y_label = "Häufigkeit"
)


plot_by_group(
  cleaned_power_consum,
  group_name = "HolidayName",
  file_name = "plots\\holiday_boxplot.png",
  colors = local_name_colors,
  title = "Übersicht der einzelnen Feiertage",
  y="PowerConsum",
  y_label="Stromverbrauch [MW]",
  x_label="Jahre"
)

plot_by_group(
  cleaned_power_consum,
  group_name = "Weekday",
  file_name = "plots\\weekday_boxplot.png",
  colors = week_colors,
  title = "Übersicht der einzelnen Wochentage",
  y = "PowerConsum",
  y_label="Stromverbrauch [MW]",
  x_label="Jahre"
)

plot_by_group(
  cleaned_power_consum,
  group_name = "WorkDay",
  file_name = "plots\\workday_boxplot.png",
  colors = working_colors,
  title = "Übersicht, ob Feiertag (FALSE) oder Werktag (TRUE)",
  y = "PowerConsum",
  y_label="Stromverbrauch [MW]",
  x_label="Jahre"
)


plot_by_column(
  df = cleaned_power_consum,
  x = "Hour",
  y = "PowerConsum",
  x_label = "Stunden",
  y_label = "Stromverbrauch [MW]",
  file_name = "plots\\hour_boxplot.png",
  title = "Übersicht der einzelnen Stunden"
)

plot_by_column(
  df = cleaned_power_consum,
  x = "Month",
  y = "PowerConsum",
  x_label = "Monate",
  y_label = "Stromverbrauch [MW]",
  file_name = "plots\\month_boxplot.png",
  title = "Übersicht der einzelnen Monate"
)

plot_by_column(
  df = cleaned_power_consum,
  x = "Week",
  y = "PowerConsum",
  x_label = "Woche",
  y_label = "Stromverbrauch [MW]",
  file_name = "plots\\week_boxplot.png",
  title = "Übersicht der einzelnen Wochen"
)

plot_by_column(
  df = cleaned_power_consum,
  x = "Year",
  y = "PowerConsum",
  x_label = "Jahr",
  y_label = "Stromverbrauch [MW]",
  file_name = "plots\\year_boxplot.png",
  title = "Übersicht der einzelnen Jahre"
)

plot_year_month_week_day(
  df=cleaned_power_consum,
  date_column="DateIndex",
  y="PowerConsum",
  from_year=2015,
  to_year=2024,
  from_week=0,
  to_week=52,
  year_for_week=2018,
  from_day=1,
  to_day=30,
  month_for_day=4,
  year_for_day=2018,
  from_month=1,
  to_month=12,
  year_for_month=2018,
  holiday="Holiday",
  day_of_week = "Weekday"
)


```
# Train-Test dataset

```{r, echo=TRUE, message=FALSE}

train_power_consum <- cleaned_power_consum |>
  filter(year(DateIndex) > 2020 & (year(DateIndex) < 2024)) 

test_power_consum <- cleaned_power_consum |>
  select(
    # WorkDay,
    WorkDay,
    # LastDayWasNotWorkDay,
    # LastDayWasNotWorkDayAndNowWorkDay,
    # NextDayIsNotWorkDayAndNowWorkDay,
    # NextDayIsHolidayAndNotWeekend,
    MeanLastWeek,
    MeanLastTwoDays,
    MaxLastOneDay,
    MinLastOneDay
  )

```

# Fit

```{r, echo=TRUE, message=FALSE}

train_power_consum |>
  model(STL(
    PowerConsum ~ season(period = 24 * 365)
    + season(period = 24 * 7)
    + season(period = 24),
    robust = TRUE
  )) |>
  components() |>
  autoplot() + labs(x = "Observation")

```

```{r, echo=TRUE, message=FALSE}
fit <- train_power_consum |>
  model(
    Mean = MEAN(PowerConsum),
    Naive = NAIVE(PowerConsum),
    Drift = NAIVE(PowerConsum ~ drift()),
    ARIMA = ARIMA(PowerConsum ~
            PDQ(D=0)
          + pdq(d=0)
          # + WorkDay
          + WorkDay
          # + NextDayIsHolidayAndNotWeekend
          + MeanLastWeek
          + MeanLastTwoDays
          + MaxLastOneDay
          + MinLastOneDay
          # xreg = cbind(fourier(PowerConsum, c(8,4,2))),
          + fourier(period = "day", K = 12)
          + fourier(period = "week", K = 5)
          + fourier(period = "year", K = 2),
          order_constraint = p+q <=12 & P+Q <=12
          ),
    PROPHET = prophet(
      PowerConsum ~ 
        MeanLastWeek
      + MeanLastTwoDays
      + MaxLastOneDay
      + MinLastOneDay
      + WorkDay 
      + season(period = 24, order = 10) 
      + season(period = 7*24, order = 5) 
      + season(period = 365*24, order = 3))
    )
    
```



```{r, echo=TRUE, message=FALSE}

days_to_forecast <- 7
months_to_forecast <- 1

test <- test_power_consum |>
  filter(year(DateIndex) == 2024) |>
  filter(month(DateIndex) >= 1) |>
  filter(month(DateIndex) <= months_to_forecast) |>
  filter(day(DateIndex) < days_to_forecast)

data_2024 <- cleaned_power_consum |>
  filter(year(DateIndex) == 2024) |>
  filter(month(DateIndex) >= 1) |>
  filter(month(DateIndex) <= months_to_forecast) |>
  filter(day(DateIndex) < days_to_forecast)

cleaned_power_consum_smard_prediction_filtered <- cleaned_power_consum_smard_prediction |>
  filter(year(DateIndex) == 2024) |>
  filter(month(DateIndex) >= 1) |>
  filter(month(DateIndex) <= months_to_forecast) |>
  filter(day(DateIndex) < days_to_forecast)


fc <- fit |>
  forecast(new_data = test) |>
  mutate(PowerConsum = PowerConsum) |>
  as_tsibble(index=DateIndex) |>
  bind_rows(cleaned_power_consum_smard_prediction_filtered)

results <- data_2024 |>
  select(DateIndex, PowerConsum) |>
  as_tibble(index="DateIndex") |>
  rename(RealPowerConsum = PowerConsum) |>
  right_join(fc, by = "DateIndex")

results_2 <- data_2024 |>
  select(DateIndex, PowerConsum) |>
  as_tibble(index="DateIndex") |>
  rename(RealPowerConsum = PowerConsum) |>
  right_join(cleaned_power_consum_smard_prediction_filtered, by = "DateIndex")

result_3 <- bind_rows(results, results_2)

metrics_by_model <- result_3 %>%
  group_by(.model) %>%  # Group by the .model column
  summarize(
    RMSE = sqrt(mean((RealPowerConsum - .mean)^2, na.rm = TRUE)),  # Calculate RMSE
    MAPE = mean(abs((RealPowerConsum - .mean) / RealPowerConsum), na.rm = TRUE) * 100,  # Calculate MAPE
    MAE = mean(abs(RealPowerConsum - .mean), na.rm = TRUE)  # Calculate MAE
  )

fc |>
  autoplot() + 
  geom_line(data = data_2024,
  aes(x = DateIndex, y = PowerConsum, color ="Testdatensatz")) +
  scale_color_manual(
      values = c(
        name = " ",
        "ARIMA" = "red",
        "Drift" = "orange",
        "Mean" = "black",
        "Naive" = "darkgrey",
        "Testdatensatz" = "blue",
        "SMARD" = "lightblue",
        "PROPHET" = "green"
      ))



fit |> select(PROPHET) |> gg_tsresiduals()
fit |> select(Mean) |> gg_tsresiduals()
fit |> select(Naive) |> gg_tsresiduals()
fit |> select(Drift) |> gg_tsresiduals()
fit |> select(ARIMA) |> gg_tsresiduals()

# cleaned_power_consum_smard_prediction |>
#     gg_tsdisplay(.mean, plot_type = "partial", lag = 400)

glance(fit)
report(fit)
```



