
```{r setup, include=FALSE}

# Load Packages
library(fhswf)
library(ggplot2)
library(tsibbledata) #0.4.1
library(dplyr)
library(tsibble)
library(fable)
library(fabletools)
library(feasts)
library(distributional)
library(lubridate)
library(broom)
library(readr)
library(tidyr)
library(datasets)
library(forecast)
library(timeDate)
library(qlcal)
library(devtools)
library(zoo)
library(corrplot)
load_all()
# devtools::document()
```


# Notizen

- Erwähnen von Saisonallen Pattern für stündliche Daten meisten Täglich, Wöchentlich und jährlich

# Define data-paths and load german holidays

```{r, echo=TRUE, message=FALSE}

# Define datapaths
power_consum_path <- "dataset\\stunde_2015_2024\\Realisierter_Stromverbrauch_201501010000_202407090000_Stunde.csv"
power_generation_path <- "dataset\\stunde_2015_2024\\Realisierte_Erzeugung_201501010000_202407090000_Stunde.csv"

```

```{r, echo=TRUE, message=FALSE}

# Load german holidays from 2015 to 2024
german_holidays <- load_german_holidays(from_year = 2015, to_year = 2024)
german_holidays <- german_holidays |> 
  mutate(date = as.Date(date)) |>
  select(localName, date)
```


# Load and cleanup power-consum, filling gaps and droping duplicates, keeping first value. 

```{r, echo=TRUE, message=FALSE}
raw_power_consum <- read.csv2(file = power_consum_path)

names(raw_power_consum)[names(raw_power_consum) == "Datum.von"] <- "DateFrom"
names(raw_power_consum)[names(raw_power_consum) == "Gesamt..Netzlast...MWh..Berechnete.Auflösungen"] <- "PowerConsum"

raw_power_consum <-  raw_power_consum |>
  select(DateFrom, PowerConsum) |>
  mutate(PowerConsum = as.numeric(gsub(",", ".", gsub("\\.", "", PowerConsum))),
         DateFrom = dmy_hm(DateFrom))

cleaned_power_consum <- raw_power_consum |>
  distinct(DateFrom, .keep_all = TRUE) |>
  mutate(DateIndex = DateFrom) |>
  as_tsibble(index = DateIndex) |>
  select(DateFrom, PowerConsum) |>
  fill_gaps() |>
  fill(PowerConsum, .direction = "downup") |>
  mutate(
    Weekday = wday(DateIndex, label = TRUE),  
    Date = as.Date(DateIndex),
    Year = as.factor(year(DateIndex)),
    Week = as.factor(week(DateIndex)),
    Hour = as.factor(hour(DateIndex)),
    Month = as.factor(month(DateIndex)),
  ) |>
  left_join(german_holidays, by = c("Date" = "date")) |>
  mutate(
    WorkDay = !(Date %in% german_holidays$date | Weekday %in% c("Sa", "So")),
    Mo = Weekday == "Mo",
    Di = Weekday == "Di",  
    Mi = Weekday == "Mi",  
    Do = Weekday == "Do",  
    Fr = Weekday == "Fr",  
    Sa = Weekday == "Sa",  
    So = Weekday == "So",
    Holiday = (Date %in% german_holidays$date),
    LastDayWasNotWorkDay = !lag(WorkDay, n=24),
    LastDayWasWeekendAndNowHoliday = (Holiday & lag(So, n=24)),
    NextDayIsWeekendAndNowHoliday = (Holiday & lead(Sa, n=24))
  ) 

cleaned_power_consum |>
  gg_tsdisplay(PowerConsum, plot_type = "partial", lag = 400)

raw_power_consum <- raw_power_consum |>
  arrange(DateFrom) |>
  mutate(
    MissingValue = difftime(DateFrom, lag(DateFrom, default = first(DateFrom)), units = "hours") == 2,
    DuplicatedDate = duplicated(DateFrom),
    Year = year(DateFrom)
  )

plot_raw_data(
  raw_power_consum,
  x = "DateFrom",
  y = "PowerConsum",
  color = "DuplicatedDate",
  missing_value = "MissingValue",
  file_name = "plots\\raw_power_consum.png"
)

```

# Generate new Features

```{r, echo=TRUE, message=FALSE}

cleaned_power_consum$localName[is.na(cleaned_power_consum$localName)] = "Working-Day"

cleaned_power_consum$MeanLastWeek <- rollapply(cleaned_power_consum$PowerConsum, width = 24*7, FUN = function(x) mean(x[1:(24*7-1)]), align = "right", fill = NA)

cleaned_power_consum$MeanLastTwoDays <- rollapply(cleaned_power_consum$PowerConsum, width = 24*2, FUN = function(x) mean(x[1:(24*2-1)]), align = "right", fill = NA)

cleaned_power_consum$MaxLastOneDay <- rollapply(cleaned_power_consum$PowerConsum, width = 24*1, FUN = function(x) max(x[1:(24*1-1)]), align = "right", fill = NA)

cleaned_power_consum$MinLastOneDay <- rollapply(cleaned_power_consum$PowerConsum, width = 24*1, FUN = function(x) min(x[1:(24*1-1)]), align = "right", fill = NA)


cor <- cor(cleaned_power_consum[sapply(cleaned_power_consum, is.numeric)], method = c("pearson", "kendall", "spearman"), use = "complete.obs")

```



# Create different Plot for analysis

```{r echo=TRUE, message=FALSE}
load_all()
local_name_colors <- c(
  "Christi Himmelfahrt" = "#E69F00",
  "Erster Weihnachtstag" = "#E69F00",
  "Karfreitag" = "#E69F00",
  "Neujahr" = "#E69F00",
  "Ostermontag" = "#E69F00",
  "Pfingstmontag" = "#E69F00",
  "Reformationstag" = "#E69F00",
  "Tag der Arbeit" = "#E69F00",
  "Tag der Deutschen Einheit" = "#E69F00",
  "Zweiter Weihnachtstag" = "#E69F00",
  "Working-Day" = "darkgrey"
)

week_colors <- c(
  "Mo" = "darkgrey",
  "Di" = "darkgrey",
  "Mi" = "darkgrey",
  "Do" = "darkgrey",
  "Fr" = "darkgrey",
  "Sa" = "#E69F00",
  "So" = "#E69F00"
)

working_colors <- c("TRUE" = "darkgrey", "FALSE" = "#E69F00")

plot_histogram_by_group(
  cleaned_power_consum,
  group_name = "WorkDay",
  file_name = "arbeitstag.png",
  colors = working_colors,
  x="PowerConsum"
)


plot_by_group(
  cleaned_power_consum,
  group_name = "localName",
  file_name = "holidays.png",
  colors = local_name_colors,
  title = "Arbeitstage"
)

plot_by_group(
  cleaned_power_consum,
  group_name = "Wochentag",
  file_name = "week.png",
  colors = week_colors,
  title = "Wochentage"
)

plot_by_group(
  cleaned_power_consum,
  group_name = "Arbeitstag",
  file_name = "working_days.png",
  colors = working_colors,
  title = "Arbeitstage"
)


plot_by_column(
  df = cleaned_power_consum,
  x = "Hour",
  y = "PowerConsum",
  x_label = "Hour",
  y_label = "Grid Load",
  file_name = "hour.png",
  title = "Hour"
)

plot_by_column(
  df = cleaned_power_consum,
  x = "Month",
  y = "PowerConsum",
  x_label = "Month",
  y_label = "Grid Load",
  file_name = "month.png",
  title = "Month"
)

plot_by_column(
  df = cleaned_power_consum,
  x = "Year",
  y = "PowerConsum",
  x_label = "Year",
  y_label = "Grid Load",
  file_name = "year.png",
  title = "Year"
)

plot_year_month_week_day(
  df=cleaned_power_consum,
  date_column="DateIndex",
  y="PowerConsum",
  from_year=2015,
  to_year=2024,
  from_week=0,
  to_week=52,
  year_for_week=2018,
  from_day=1,
  to_day=30,
  month_for_day=4,
  year_for_day=2018,
  from_month=1,
  to_month=12,
  year_for_month=2018,
  holiday="Holiday",
  day_of_week = "Wochentag"
)


```

# Fit

```{r, echo=TRUE, message=FALSE}

fit <- cleaned_power_consum |>
  filter(year(DateIndex) < 2018) |>
  fill_gaps() |>
  model(
    ARIMA(PowerConsum ~ 
            PDQ(D=0) 
          + pdq(d=0) 
          + Arbeitstag 
          + MeanLastWeek 
          + MeanLastTwoDays 
          + MaxLastOneDay 
          + MinLastOneDay 
          + LastTwoDaysWasHoliday
          + fourier(period = "day", K = 10)
          + fourier(period = "week", K = 10)
          + fourier(period = "year", K = 5)
          )
  )
```



```{r, echo=TRUE, message=FALSE}

days_to_forecast <- 7

test <- cleaned_power_consum |>
  filter(year(DateIndex) == 2018) |>
  filter(month(DateIndex) == 1) |>
  filter(day(DateIndex) < days_to_forecast) |>
  select(Arbeitstag,
         Mo,
         Di,
         Mi,
         Do,
         Fr,
         Sa,
         So,
         MeanLastWeek,
         MeanLastTwoDays,
         MaxLastOneDay,
         MinLastOneDay,
         LastTwoDaysWasHoliday) |>
  fill_gaps()

data_2016 <- cleaned_power_consum |>
  filter((year(DateIndex) == 2017 & month(DateIndex) == 12 & day(DateIndex) > 20) | 
         (year(DateIndex) == 2018 & month(DateIndex) == 1 & day(DateIndex) < days_to_forecast))


fc <- fit |>
  forecast(new_data = test) |>
  mutate(.mean = .mean,
         PowerConsum = PowerConsum)

results <- data_2016 |>
  select(DateIndex, PowerConsum) |>
  rename(Actual = PowerConsum) |>
  right_join(fc, by = "DateIndex") |> 
  rename(Forecast = .mean)

rmse <- sqrt(mean((results$Actual - results$Forecast)^2, na.rm = TRUE))
mape <- mean(abs((results$Actual - results$Forecast) / results$Actual), na.rm = TRUE) * 100
mae <- mean(abs(results$Actual - results$Forecast), na.rm = TRUE)



fc |>
  autoplot() + 
  geom_line(data = data_2016,
  aes(x = DateIndex, y = PowerConsum, color ="Testdatensatz"))

fit |> gg_tsresiduals()

glance(fit)
report(fit)
```



