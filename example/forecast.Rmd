

# Load Packages
```{r setup, include=FALSE}

# Load Packages
library(fhswf)
library(ggplot2)
library(tsibbledata) #0.4.1
library(dplyr)
library(tsibble)
library(fable)
library(fabletools)
library(feasts)
library(distributional)
library(lubridate)
library(broom)
library(readr)
library(tidyr)
library(datasets)
library(forecast)
library(timeDate)
library(qlcal)
library(devtools)
library(zoo)
library(corrplot)
library(scales)
library(fable.prophet)
library(mgcv)
library(MEFM)
load_all()
# devtools::document()
```


# Notizen

- Erwähnen von Saisonallen Pattern für stündliche Daten meisten Täglich, Wöchentlich und jährlich

# Define data-paths and load german holidays

```{r, echo=TRUE, message=FALSE}

# Define datapaths
power_consum_path <- "dataset\\stunde_2015_2024\\Realisierter_Stromverbrauch_201501010000_202407090000_Stunde.csv"
power_generation_path <- "dataset\\stunde_2015_2024\\Realisierte_Erzeugung_201501010000_202407090000_Stunde.csv"
power_consum_smard_prediction_path <- "dataset\\propgnose_vom_smard\\Prognostizierter_Stromverbrauch_202401010000_202407090000_Stunde.csv"

```

```{r, echo=TRUE, message=FALSE}

# Load german holidays from 2015 to 2024
german_holidays <- load_german_holidays(from_year = 2015, to_year = 2024, location="/DE")
german_holidays <- german_holidays |> 
  mutate(date = as.Date(date)) |>
  select(localName, date)
```


# Load and cleanup power-consum, filling gaps and droping duplicates, keeping first value. 

```{r, echo=TRUE, message=FALSE}

load_power_consum <- function(path) {
  raw_power_consum <- read.csv2(file = path)
  
  names(raw_power_consum)[names(raw_power_consum) == "Datum.von"] <- "DateFrom"
  names(raw_power_consum)[names(raw_power_consum) == "Gesamt..Netzlast...MWh..Berechnete.Auflösungen"] <- "PowerConsum"
  
  raw_power_consum <-  raw_power_consum |>
    select(DateFrom, PowerConsum) |>
    mutate(PowerConsum = as.numeric(gsub(",", ".", gsub("\\.", "", PowerConsum))),
           DateFrom = dmy_hm(DateFrom))
  
  cleaned_power_consum <- raw_power_consum |>
    distinct(DateFrom, .keep_all = TRUE) |>
    mutate(DateIndex = DateFrom) |>
    as_tsibble(index = DateIndex) |>
    select(DateFrom, PowerConsum) |>
    fill_gaps() |>
    fill(PowerConsum, .direction = "downup") |>
    mutate(
      Weekday = wday(DateIndex, label = TRUE),  
      Date = as.Date(DateIndex),
      Year = as.factor(year(DateIndex)),
      Week = as.factor(week(DateIndex)),
      Hour = as.factor(hour(DateIndex)),
      Month = as.factor(month(DateIndex)),
    ) |>
    left_join(german_holidays, by = c("Date" = "date")) |>
    mutate(
      WorkDay = ifelse(!(Date %in% german_holidays$date | Weekday %in% c("Sa", "So")), 1, 0),
      Mo = Weekday == "Mo",
      Di = Weekday == "Di",  
      Mi = Weekday == "Mi",  
      Do = Weekday == "Do",  
      Fr = Weekday == "Fr",  
      Sa = Weekday == "Sa",  
      So = Weekday == "So",
      Holiday = ifelse(Date %in% german_holidays$date, 1, 0),
      WorkdayHolidayWeekend = paste0(ifelse(Holiday, "Feiertag", "Kein Feiertag"), ifelse(Weekday %in% c("Sa", "So"), "\nWochenende","\nKein Wochenende")),
      HolidayAndWorkDay = ifelse((Holiday & !(Weekday %in% c("Sa", "So"))), 1, 0),
      LastDayWasNotWorkDay = !lag(WorkDay, n=24),
      LastDayWasNotWorkDayAndNowWorkDay = (LastDayWasNotWorkDay & WorkDay),
      NextDayIsNotWorkDayAndNowWorkDay= (WorkDay & !lead(WorkDay, n=24)),
      LastDayWasHolodiayAndNotWeekend = ifelse((lag(Holiday, n=24) & (!Sa | !So)), 1, 0),
      NextDayIsHolidayAndNotWeekend = ifelse((lead(Holiday, n=24) & (!lead(Sa, n=24) | !lead(So, n=24))),1,0),
      HolidayName = ifelse(is.na(localName), "Regulärer Tag", localName)
    )
  
  cleaned_power_consum |>
    gg_tsdisplay(PowerConsum, plot_type = "partial", lag = 400)

  raw_power_consum <- raw_power_consum |>
    arrange(DateFrom) |>
    mutate(
      MissingValue = difftime(DateFrom, lag(DateFrom, default = first(DateFrom)), units = "hours") == 2,
      DuplicatedDate = duplicated(DateFrom),
      Year = year(DateFrom)
    )

  plot_raw_data(
    df = raw_power_consum,
    x = "DateFrom",
    y = "PowerConsum",
    color = "DuplicatedDate",
    missing_value = "MissingValue",
    file_name = "plots\\raw_power_consum.png"
  )
  
  return(list(raw_power_consum = raw_power_consum, cleaned_power_consum = cleaned_power_consum))
}

power_consum_smard_prediction_loaded <- load_power_consum(path=power_consum_smard_prediction_path)
raw_smard_pred <- power_consum_smard_prediction_loaded$raw_power_consum
cleaned_smard_pred <- power_consum_smard_prediction_loaded$cleaned_power_consum

cleaned_smard_pred <- cleaned_smard_pred |>
  mutate(.model = "SMARD")
names(cleaned_smard_pred)[names(cleaned_smard_pred) == "PowerConsum"] <- ".mean"

power_consum_loaded <- load_power_consum(path=power_consum_path)
raw_power_consum <- power_consum_loaded$raw_power_consum
cleaned_power_consum <- power_consum_loaded$cleaned_power_consum

rm(power_consum_loaded)
rm(power_consum_smard_prediction_loaded)
rm(power_consum_path)
rm(german_holidays)
rm(power_consum_smard_prediction_path)
rm(power_generation_path)

```

# Generate new Features

```{r, echo=TRUE, message=FALSE}

cleaned_power_consum$localName[is.na(cleaned_power_consum$localName)] = "Working-Day"

cleaned_power_consum$MeanLastWeek <- rollapply(cleaned_power_consum$PowerConsum, width = 24*8, FUN = function(x) mean(x[1:(24*8-25)]), align = "right", fill = NA) 

cleaned_power_consum$MeanLastTwoDays <- rollapply(cleaned_power_consum$PowerConsum, width = 24*3, FUN = function(x) mean(x[1:(24*3-25)]), align = "right", fill = NA) 

cleaned_power_consum$MaxLastOneDay <- rollapply(cleaned_power_consum$PowerConsum, width = 24*2, FUN = function(x) max(x[1:(24*2-25)]), align = "right", fill = NA) 

cleaned_power_consum$MinLastOneDay <- rollapply(cleaned_power_consum$PowerConsum, width = 24*2, FUN = function(x) min(x[1:(24*2-25)]), align = "right", fill = NA) 


cor <- cor(cleaned_power_consum[sapply(cleaned_power_consum, is.numeric)], method = c("pearson", "kendall", "spearman"), use = "complete.obs")

```



# Create different Plot for analysis

```{r echo=TRUE, message=FALSE}
load_all()
local_name_colors <- c(
  "Christi Himmelfahrt" = palette()[2],
  "Erster Weihnachtstag" = palette()[2],
  "Karfreitag" = palette()[2],
  "Neujahr" = palette()[2],
  "Ostermontag" = palette()[2],
  "Pfingstmontag" = palette()[2],
  "Reformationstag" = palette()[2],
  "Tag der Arbeit" = palette()[2],
  "Tag der Deutschen Einheit" = palette()[2],
  "Zweiter Weihnachtstag" = palette()[2],
  "Regulärer Tag" = palette()[1]
)


week_colors <- c(
  "Mo" = palette()[1],
  "Di" = palette()[1],
  "Mi" = palette()[1],
  "Do" = palette()[1],
  "Fr" = palette()[1],
  "Sa" = palette()[2],
  "So" = palette()[2]
)


working_colors <- c("1" = "#2E9FDF", "0" = "#FC4E07")

whw_colors <- c(
  "Feiertag\nKein Wochenende" = "black",
  "Kein Feiertag\nKein Wochenende" = "red",
  "Kein Feiertag\nWochenende" = "orange",
  "Feiertag\nWochenende" = "blue"
)

plot_histogram_by_group(
  cleaned_power_consum,
  group_name = "WorkdayHolidayWeekend",
  file_name = "plots\\workday_holiday_weekend_histogram.png",
  colors = whw_colors,
  x="PowerConsum",
  x_label = "Stromverbrauch [MW]",
  y_label = "Häufigkeit",
  name_0 = "Wochenende oder Feiertage",
  name_1 = "Werktag"
)


plot_histogram_by_group(
  cleaned_power_consum,
  group_name = "WorkDay",
  file_name = "plots\\workday_histogram.png",
  colors = working_colors,
  x="PowerConsum",
  x_label = "Stromverbrauch [MW]",
  y_label = "Häufigkeit",
  name_0 = "Wochenende oder Feiertage",
  name_1 = "Werktag"
)

plot_histogram_by_group(
  cleaned_power_consum,
  group_name = "Holiday",
  file_name = "plots\\holiday_histogram.png",
  colors = working_colors,
  x="PowerConsum",
  x_label = "Stromverbrauch [MW]",
  y_label = "Häufigkeit",
  name_0 = "Werktag oder Wochenende",
  name_1 = "Feiertag"
)

plot_histogram_by_group(
  cleaned_power_consum,
  group_name = "HolidayAndWorkDay",
  file_name = "plots\\holiday_workday_histogram.png",
  colors = working_colors,
  x="PowerConsum",
  x_label = "Stromverbrauch [MW]",
  y_label = "Häufigkeit",
  name_0 = "Wochenende oder Werktag",
  name_1 = "Feiertag am Werktag"
)

plot_by_group(
  cleaned_power_consum,
  group_name = "HolidayName",
  file_name = "plots\\holiday_boxplot.png",
  colors = local_name_colors,
  title = "Übersicht der einzelnen Feiertage",
  y="PowerConsum",
  y_label="Stromverbrauch [MW]",
  x_label="Jahre"
)

plot_by_group(
  cleaned_power_consum,
  group_name = "Weekday",
  file_name = "plots\\weekday_boxplot.png",
  colors = week_colors,
  title = "Übersicht der einzelnen Wochentage",
  y = "PowerConsum",
  y_label="Stromverbrauch [MW]",
  x_label="Jahre"
)

plot_by_group(
  cleaned_power_consum,
  group_name = "WorkDay",
  file_name = "plots\\workday_boxplot.png",
  colors = working_colors,
  title = "Übersicht, ob Feiertag (FALSE) oder Werktag (TRUE)",
  y = "PowerConsum",
  y_label="Stromverbrauch [MW]",
  x_label="Jahre"
)


plot_by_column(
  df = cleaned_power_consum,
  x = "Hour",
  y = "PowerConsum",
  x_label = "Stunden",
  y_label = "Stromverbrauch [MW]",
  file_name = "plots\\hour_boxplot.png",
  title = "Übersicht der einzelnen Stunden"
)

plot_by_column(
  df = cleaned_power_consum,
  x = "Month",
  y = "PowerConsum",
  x_label = "Monate",
  y_label = "Stromverbrauch [MW]",
  file_name = "plots\\month_boxplot.png",
  title = "Übersicht der einzelnen Monate"
)

plot_by_column(
  df = cleaned_power_consum,
  x = "Week",
  y = "PowerConsum",
  x_label = "Woche",
  y_label = "Stromverbrauch [MW]",
  file_name = "plots\\week_boxplot.png",
  title = "Übersicht der einzelnen Wochen"
)

plot_by_column(
  df = cleaned_power_consum,
  x = "Year",
  y = "PowerConsum",
  x_label = "Jahr",
  y_label = "Stromverbrauch [MW]",
  file_name = "plots\\year_boxplot.png",
  title = "Übersicht der einzelnen Jahre"
)

plot_year_month_week_day(
  df=cleaned_power_consum,
  date_column="DateIndex",
  y="PowerConsum",
  from_year=2015,
  to_year=2024,
  from_week=0,
  to_week=52,
  year_for_week=2018,
  from_day=1,
  to_day=30,
  month_for_day=4,
  year_for_day=2018,
  from_month=1,
  to_month=12,
  year_for_month=2018,
  holiday="Holiday",
  day_of_week = "Weekday"
)


```
# Train-Test dataset also Transformation

```{r, echo=TRUE, message=FALSE}

train_power_consum <- cleaned_power_consum |>
  filter(year(DateIndex) > 2020 & (year(DateIndex) < 2024))
```

# Fit

```{r, echo=TRUE, message=FALSE}

train_power_consum |>
  model(STL(
    PowerConsum ~ season(period = 24 * 365)
    + season(period = 24 * 7)
    + season(period = 24),
    robust = TRUE
  )) |>
  components() |>
  autoplot() + labs(x = "Observation")

lambda <- train_power_consum |>
  features(PowerConsum, features = guerrero) |>
  pull(lambda_guerrero)
train_power_consum_transformed <- train_power_consum |>
  mutate(PowerConsum = box_cox(PowerConsum, lambda))

train_power_consum_transformed |>
  gg_tsdisplay(PowerConsum, plot_type = "partial", lag = 400)

```

Starting Model

```{r, echo=TRUE, message=FALSE}

fit <- train_power_consum |>
  model(
    ARIMA = ARIMA(PowerConsum ~
            PDQ(0,0,0)
          + pdq(d=0)
          + WorkDay
          + Holiday
          + MeanLastWeek
          + MeanLastTwoDays
          + MaxLastOneDay
          + MinLastOneDay
          + LastDayWasHolodiayAndNotWeekend
          + NextDayIsHolidayAndNotWeekend
          + fourier(period = "day", K = 10)
          + fourier(period = "week", K = 5)
          + fourier(period = "year", K = 3)
          )
  )

saveRDS(fit, file = "model/arima_0_2021_2023.rds")
```

What if no Holiday after before effect

```{r, echo=TRUE, message=FALSE}

fit <- train_power_consum |>
  model(
    ARIMA = ARIMA(PowerConsum ~
            PDQ(0,0,0)
          + pdq(d=0)
          + WorkDay
          + Holiday
          + MeanLastWeek
          + MeanLastTwoDays
          + MaxLastOneDay
          + MinLastOneDay
          + fourier(period = "day", K = 10)
          + fourier(period = "week", K = 5)
          + fourier(period = "year", K = 3)
          )
  )

saveRDS(fit, file = "model/arima_1_2021_2023.rds")
```

What if period day 8 

```{r, echo=TRUE, message=FALSE}

fit <- train_power_consum |>
  model(
    ARIMA = ARIMA(PowerConsum ~
            PDQ(0,0,0)
          + pdq(d=0)
          + WorkDay
          + Holiday
          + MeanLastWeek
          + MeanLastTwoDays
          + MaxLastOneDay
          + MinLastOneDay
          + LastDayWasHolodiayAndNotWeekend
          + NextDayIsHolidayAndNotWeekend
          + fourier(period = "day", K = 8)
          + fourier(period = "week", K = 5)
          + fourier(period = "year", K = 3)
          )
  )

saveRDS(fit, file = "model/arima_2_2021_2023.rds")
```


```{r, echo=TRUE, message=FALSE}

fit <- train_power_consum |>
  model(
    ARIMA = ARIMA(PowerConsum ~
            PDQ(0,0,0)
          + pdq(d=0)
          + WorkDay
          + Holiday
          + LastDayWasHolodiayAndNotWeekend
          + NextDayIsHolidayAndNotWeekend
          + fourier(period = "day", K = 8)
          + fourier(period = "week", K = 5)
          + fourier(period = "year", K = 3)
          )
  )

saveRDS(fit, file = "model/arima_3_2021_2023.rds")
```

```{r, echo=TRUE, message=FALSE}

fit <- train_power_consum |>
  model(
    ARIMA = ARIMA(PowerConsum ~
            PDQ(0,0,0)
          + pdq(d=0)
          + WorkDay
          + Holiday
          + MeanLastWeek
          + MeanLastTwoDays
          + MaxLastOneDay
          + MinLastOneDay
          + LastDayWasHolodiayAndNotWeekend
          + NextDayIsHolidayAndNotWeekend
          + fourier(period = "day", K = 8)
          + fourier(period = "week", K = 5)
          + fourier(period = "year", K = 3)
          )
  )

saveRDS(fit, file = "model/arima_4_2021_2023.rds")
```


```{r, echo=TRUE, message=FALSE}
fit <- train_power_consum |>
  model(
    ARIMA = ARIMA(PowerConsum ~
            PDQ(0,0,0)
          + pdq(d=0)
          + WorkDay
          + Holiday
          + MeanLastWeek
          + MeanLastTwoDays
          + MaxLastOneDay
          + MinLastOneDay
          + LastDayWasHolodiayAndNotWeekend
          + NextDayIsHolidayAndNotWeekend
          + fourier(period = 24, K = 8)
          + fourier(period = 24*7, K = 5)
          + fourier(period = 24*365.25, K = 3)
          )
  )

saveRDS(fit, file = "model/arima_5_2021_2023.rds")
```


```{r, echo=TRUE, message=FALSE}

# /example/model/arima_1
fit <- train_power_consum |>
  model(
    TSLM = TSLM(PowerConsum ~
          WorkDay
          + Holiday
          + MeanLastWeek
          + MeanLastTwoDays
          + MaxLastOneDay
          + MinLastOneDay
          + LastDayWasHolodiayAndNotWeekend
          + NextDayIsHolidayAndNotWeekend
          + fourier(period = "day", K = 12)
          + fourier(period = "week", K = 24)
          + fourier(period = "year", K = 24)
          )
  )

saveRDS(fit, file = "model/tslm_0_2021_2023.rds")
```


```{r, echo=TRUE, message=FALSE}

fit <- train_power_consum |>
  model(
    Mean = MEAN(PowerConsum),
    )

saveRDS(fit, file = "model/mean_2021_2023.rds")   

fit <- train_power_consum |>
  model(
    Naive = NAIVE(PowerConsum),
    Drift = NAIVE(PowerConsum ~ drift())
    ) 

saveRDS(fit, file = "model/naive_2021_2023.rds")  

fit <- train_power_consum |>
  model(
    Drift = NAIVE(PowerConsum ~ drift())
    ) 

saveRDS(fit, file = "model/drift_2021_2023.rds")  
```

```{r, echo=TRUE, message=FALSE}

fit <- train_power_consum |>
  model(
    PROPHET = prophet(
      PowerConsum ~ 
        MeanLastWeek
      + MeanLastTwoDays
      + MaxLastOneDay
      + MinLastOneDay
      + WorkDay 
      + Holiday
      + LastDayWasHolodiayAndNotWeekend
      + NextDayIsHolidayAndNotWeekend
      + season(period = "day", order = 24) 
      + season(period = "week", order = 5) 
      + season(period = "year", order = 3))
    )

saveRDS(fit, file = "model/prophet_0_2021_2023.rds")    
```

```{r, echo=TRUE, message=FALSE}

train_power_consum_a  <- train_power_consum |>
  mutate(HolidayXREG = Holiday * MeanLastTwoDays)

xreg_holiday <- list(train_power_consum_a$HolidayXREG) 
```


```{r, echo=TRUE, message=FALSE}

# TODO HERE 
# Finde richtige holiday handling
fit <- train_power_consum |>
  model(
    ARIMA = ARIMA(PowerConsum ~
            PDQ(0,0,0)
          + pdq(d=0)
          + WorkDay
          + Holiday
          + MeanLastWeek
          + MeanLastTwoDays
          + MaxLastOneDay
          + MinLastOneDay
          + LastDayWasHolodiayAndNotWeekend
          + NextDayIsHolidayAndNotWeekend
          + fourier(period = 24, K = 8)
          + fourier(period = 24*7, K = 5)
          + fourier(period = 24*365.25, K = 3)
          + xreg(fixed = xreg_holiday)
          )
  )

saveRDS(fit, file = "model/arima_6_2021_2023.rds")
```

# Load All Models and Metrics Evaluation

```{r, echo=TRUE, message=FALSE}
load_all()
fc <- load_all_model_results(
  days_to_forecast = 40,
  months_to_forecast = 6,
  year_to_forecast = 2024,
  starting_month = 1,
  smard_fc = cleaned_smard_pred,
  real_data = cleaned_power_consum
)

all_forecasts <- fc$combined_forecasts
raw_fc <- fc$raw_forecasts
all_fits <- fc$all_fits

metric_results <- calculate_metrics(fc_data = all_forecasts)

rm(fc)

name_of_best_model <- plot_forecast(
  all_forecasts = all_forecasts,
  metric_results = metric_results,
  cleaned_power_consum = cleaned_power_consum,
  raw_fc = raw_fc,
  month_to_plot = 1,
  days_to_plot = 40
)

best_fit <- readRDS(paste0("model/", name_of_best_model))
best_fit |>
  gg_tsresiduals()
 
glance(best_fit)
report(best_fit)

```


